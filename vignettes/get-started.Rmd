---
title: "Get started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(odsrmd)
```

<!-- This vignette is generated by fusen: do not edit by hand -->

```{r}
library(dplyr)
```

This vignette guides you through the procedure to display the content of an Rmarkdown file on a classic page from the Opendatasoft platform. Here we will take a simple Rmarkdown file, stored as example in the package {odsrmd}. You can prepare you own Rmarkdown file. Note that you can query data from your own platform using the [API version 2](https://help.opendatasoft.com/apis/ods-explore-v2/). 


We assume that you have access to an Opendatasoft platform and have the rights to create and edit a page on the platform. As described in the README, you need to add the following environment variables to your Renviron file: `ODS_DOMAIN_ID`, `ODS_USERNAME` and `ODS_PASSWORD`. The `ODS_DOMAIN_ID` variable corresponds to the domain ID of your Opendatasoft domain. `ODS_USERNAME` and `ODS_PASSWORD` correspond respectively to your username and password to access the platform.        
We also assume that you already created an empty classic page, for which the page URL (or page slug) is "test".






## api_error_body

    

  

```{r example-api_error_body}
#' \dontrun{
#' library(httr2)
#' 
#' ods_domain_id <- Sys.getenv("ODS_DOMAIN_ID")
#' ods_username <- Sys.getenv("ODS_USERNAME")
#' ods_password <- Sys.getenv("ODS_PASSWORD")
#' 
#' domain_url <- paste0("https://", ods_domain_id, ".opendatasoft.com/api/management/v2/")
#' page_slug <- "test"
#' 
#' resp <- request(domain_url) %>%
#'   req_auth_basic(username = ods_username, password = ods_password) %>%
#'   req_url_path_append("p", page_slug) %>%
#'   req_user_agent("R package odsrmd") %>%
#'   req_perform()
#' 
#' api_error_body(last_response())
#' }
```

  

  






    

## get_body_and_style

    
Here we render the Rmarkdown file as an .html file and extract the html the html nodes corresponding to body and style of the page. You cannot include scripts on a classic page from the Opendatasoft platform. Scripts nodes are removed from the html document and interactive libraries such as {plotly} or {highcharter} cannot be used here in the Rmarkdown document.     
    

  

```{r example-get_body_and_style}
# Temporary directory for reproducible example
dir_tmp <- tempfile(pattern = "proj-")
dir.create(dir_tmp)

file.copy(from = system.file("examples/example_rmd.Rmd", package = "odsrmd"), to=dir_tmp)
# browseURL(dir_tmp)
path <- paste0(dir_tmp, "/example_rmd.Rmd")

get_body_and_style(path)
```

  

## get_ods_page

    
Here we assume that you have access to an Opendatasoft platform and have the rights to create and edit a page on the platform. We also assume that you added the `ODS_DOMAIN_ID`, `ODS_USERNAME` and `ODS_PASSWORD`environment variables to your Renviron file.   
And we also assume that you already created an empty classic page on the platform, for which the page URL (or page slug) is "test".     

The get_ods_page() function gets all pre-existing information of the page, such as its title, description, tags and current content. If no other information is provided, these elements will be re-used in create_json() to create the JSON object that will be sent back on the Opendatasoft platform using the put_ods_page() function.       


  

```{r example-get_ods_page}
get_ods_page(page_slug = "test")

```

  

  



## create_json

Now we combine information coming from the Opendatasoft page (with get_ods_page()) and the Rmarkdown document (with get_body_and_style()) into a JSON object ready to be sent back to the Opendatasoft platform.     

    

  

```{r example-create_json}
# Temporary directory for reproducible example
dir_tmp <- tempfile(pattern = "proj-")
dir.create(dir_tmp)

file.copy(from = system.file("examples/example_rmd.Rmd", package = "odsrmd"), to=dir_tmp)
# browseURL(dir_tmp)
path <- paste0(dir_tmp, "/example_rmd.Rmd")

body_and_style <- get_body_and_style(path)


page_elements <- get_ods_page(page_slug = "test")

create_json(page_elements, body_and_style, language = NULL, 
                        title = NULL, description = NULL, template = NULL, 
                        tags = NULL, restricted = NULL)
```

  

  

## put_ods_page

put_ods_page() updates the content of the page on the Opendatasoft platform with a JSON object. It sends back an HTTP response if the request is successful, otherwise it throws an error.    
    

  

```{r example-put_ods_page}

# Temporary directory for reproducible example
dir_tmp <- tempfile(pattern = "proj-")
dir.create(dir_tmp)

file.copy(from = system.file("examples/example_rmd.Rmd", package = "odsrmd"), to=dir_tmp)
# browseURL(dir_tmp)
path <- paste0(dir_tmp, "/example_rmd.Rmd")

body_and_style <- get_body_and_style(path)


page_elements <- get_ods_page(page_slug = "test")

json_to_send <- create_json(page_elements, body_and_style, language = NULL, 
                        title = NULL, description = NULL, template = NULL, 
                        tags = NULL, restricted = NULL)
page_slug <- "test"

put_ods_page(page_slug, json_to_send)


```

  

  




